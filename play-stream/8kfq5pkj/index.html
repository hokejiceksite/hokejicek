<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hokej√≠ƒçek | Stream</title>

  <!-- Lok√°ln√≠ knihovny -->
  <script src="/assets/lib/clappr.min.js"></script>
  <script src="/assets/lib/hlsjs-playback.min.js"></script>

  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;}
    #player{width:100%;height:100vh;}
    #loading {
      color: #fff;
      font-family: system-ui, sans-serif;
      text-align: center;
      margin-top: 20%;
      font-size: 20px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div id="loading">üé• Naƒç√≠t√°m stream‚Ä¶</div>
  <div id="player"></div>

  <script>
    // ‚úÖ Povolen√© dom√©ny
    const allowed = ["hokejicek.site","starstreams.pro","w3schools.com"];
    const ref = document.referrer || location.hostname;
    if(!allowed.some(h=>ref.includes(h))){
      document.body.innerHTML="<p style='color:white;text-align:center;margin-top:20%'>Tento p≈ôehr√°vaƒç zde nen√≠ povolen.</p>";
      throw new Error("Neautorizovan√Ω hostitel");
    }

    // ‚ùå Zak√°zat prav√© tlaƒç√≠tko
    document.addEventListener("contextmenu",e=>e.preventDefault());

    // ‚úÖ Adresa tv√© proxy (zmƒõ≈à podle sv√©ho Vercel projektu)
    const vercelProxy = "https://tv-proxy-abc.vercel.app"; // ‚Üê uprav podle sv√©ho n√°zvu projektu

    // üéûÔ∏è P≈Øvodn√≠ M3U8 stream
    const originSrc = "https://stream-48.mazana.tv/V2_emn.m3u8s?codec_id=1240&session=omg";

    // üîë Naƒçti token z proxy a spus≈• p≈ôehr√°vaƒç
    async function initPlayer() {
      try {
        const originEnc = encodeURIComponent(originSrc);
        const tokenUrl = `${vercelProxy}/api/token?src=${originEnc}`;
        const tokenResp = await fetch(tokenUrl);
        const data = await tokenResp.json();

        if (!data.url) {
          document.getElementById("loading").textContent = "‚ùå Chyba p≈ôi z√≠sk√°v√°n√≠ tokenu.";
          return;
        }

        const fullStreamUrl = data.url.startsWith("/")
          ? `${vercelProxy}${data.url}`
          : data.url;

        // üß© Inicializace Clappr
        var player = new Clappr.Player({
          parentId: "#player",
          source: fullStreamUrl,
          plugins: [HlsjsPlayback],
          mimeType: "application/x-mpegURL",
          width: "100%",
          height: "100%",
          autoPlay: true,
          mute: false,
          playback: { hlsjsConfig: { lowLatencyMode: true } }
        });

        player.on(Clappr.Events.PLAYER_READY, function(){
          document.getElementById("loading").style.display = "none";
        });

        player.on(Clappr.Events.PLAYER_ERROR, function(){
          document.getElementById("loading").textContent = "‚ö†Ô∏è Chyba p≈ôehr√°v√°n√≠.";
        });

      } catch (err) {
        console.error(err);
        document.getElementById("loading").textContent = "‚ùå Nelze inicializovat p≈ôehr√°vaƒç.";
      }
    }

    initPlayer();
  </script>
</body>
</html>
