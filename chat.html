<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hokejíček Chat (embed)</title>
  <style>
    body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:#0b0b0b;color:#fff}
    .wrap{display:flex;flex-direction:column;height:100vh}
    header{padding:10px;background:#111;border-bottom:1px solid #222;display:flex;gap:10px;align-items:center}
    #logo{height:48px}
    .auth{margin-left:auto;display:flex;gap:6px}
    input,button,select{padding:8px;border-radius:6px;border:none;background:#1a1a1a;color:#fff}
    button{background:#4da3ff;cursor:pointer}
    #content{display:flex;flex-direction:column;flex:1}
    #messages{flex:1;overflow:auto;padding:12px;background:#0f0f0f;border-top:1px solid #222}
    .msg{padding:6px;border-bottom:1px solid #131313}
    .meta{color:#aaa;font-size:0.85em;margin-bottom:4px}
    .controls{display:flex;padding:10px;gap:8px;border-top:1px solid #222;background:#0f0f0f}
    .small{font-size:0.9em}
    .report{background:#e06b6b;color:#fff;padding:6px;border-radius:6px;border:none;cursor:pointer}
    .admin-tools{display:flex;gap:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img id="logo" src="https://hokejicek.site/files/png/hokejicek-logo.png" alt="logo">
      <div class="auth" id="authArea">
        <!-- registration / login UI injected here -->
      </div>
    </header>

    <div id="content">
      <div id="messages"></div>

      <div class="controls">
        <input id="usernameInput" placeholder="Jméno (pouze při registraci)" class="small">
        <input id="textInput" placeholder="Napiš zprávu..." style="flex:1">
        <button id="sendBtn">Odeslat</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  // ==== ZDE doplň svůj firebaseConfig (z Project settings) ====
const firebaseConfig = {
  apiKey: "AIzaSyBtf3bEzJU5et-Q11j38QHNMHyOeoOb98A",
  authDomain: "hokejicek-2fe46.firebaseapp.com",
  databaseURL: "https://hokejicek-2fe46-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hokejicek-2fe46",
  storageBucket: "hokejicek-2fe46.firebasestorage.app",
  messagingSenderId: "980610969771",
  appId: "1:980610969771:web:1b03ca9715204ef6bd47ee",
  measurementId: "G-M0FJ2RMY9V"
};
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const messagesRef = db.ref('messages');
  const usersRef = db.ref('users');
  const reportsRef = db.ref('reports');
  const bansRef = db.ref('bans');
  const adminsRef = db.ref('admins');

  const authArea = document.getElementById('authArea');
  const messagesEl = document.getElementById('messages');
  const usernameInput = document.getElementById('usernameInput');
  const textInput = document.getElementById('textInput');
  const sendBtn = document.getElementById('sendBtn');

  // RENDER auth area (login/register/logout)
  function renderAuth(user) {
    authArea.innerHTML = '';
    if (!user) {
      const regBtn = document.createElement('button'); regBtn.textContent='Registrovat'; regBtn.onclick=showRegister;
      const loginBtn = document.createElement('button'); loginBtn.textContent='Přihlásit'; loginBtn.onclick=showLogin;
      authArea.appendChild(regBtn); authArea.appendChild(loginBtn);
    } else {
      const span = document.createElement('span'); span.textContent = 'Přihlášen: ' + (user.displayName || user.email);
      const logout = document.createElement('button'); logout.textContent='Odhlásit'; logout.onclick = ()=>auth.signOut();
      authArea.appendChild(span); authArea.appendChild(logout);
    }
  }

  function showRegister(){
    const name = prompt('Zadej uživatelské jméno (malá písmena, čísla, - a _):');
    if(!name) return;
    const valid = /^[a-z0-9_-]{3,20}$/.test(name);
    if(!valid){ alert('Neplatné uživatelské jméno. Použij 3–20 znaků: a-z0-9_-'); return; }
    const pass = prompt('Heslo (min. 6 znaků):');
    if(!pass || pass.length<6){ alert('Nízká délka hesla'); return; }

    // check if username exists
    usersRef.orderByChild('username').equalTo(name).once('value', snap=>{
      if(snap.exists()){ alert('Uživatelské jméno obsazeno.'); return; }
      // create auth user with fake email username@hokejicek.local
      const email = `${name}@hokejicek.local`;
      auth.createUserWithEmailAndPassword(email, pass)
        .then(cred=>{
          const uid = cred.user.uid;
          // set displayName & store profile
          cred.user.updateProfile({ displayName: name });
          usersRef.child(uid).set({ username: name, created: Date.now() });
          alert('Registrace hotova, jsi přihlášen.');
        })
        .catch(err=>alert('Chyba registrace: '+err.message));
    });
  }

  function showLogin(){
    const name = prompt('Uživatelské jméno:');
    if(!name) return;
    const pass = prompt('Heslo:');
    if(!pass) return;
    const email = `${name}@hokejicek.local`;
    auth.signInWithEmailAndPassword(email, pass)
      .catch(err => alert('Chyba přihlášení: '+err.message));
  }

  // on auth state changed
  auth.onAuthStateChanged(async user=>{
    renderAuth(user);
    if(user){
      // set displayName from profile stored in db
      const u = await usersRef.child(user.uid).once('value');
      if(u.exists() && u.val().username) user.updateProfile({displayName:u.val().username});
    }
  });

  // load existing messages and listen to new
  function addMessageToDom(id, msgObj){
    // ignore messages from banned users (we'll still allow admins to see reports)
    bansRef.child(msgObj.userId).once('value', bSnap=>{
      if(bSnap.exists()) return; // skip rendering banned user's messages
      const div = document.createElement('div');
      div.className = 'msg';
      const meta = document.createElement('div');
      meta.className='meta';
      meta.textContent = `${msgObj.username} • ${new Date(msgObj.time).toLocaleTimeString()}`;
      const text = document.createElement('div');
      text.textContent = msgObj.text;
      const btnReport = document.createElement('button');
      btnReport.textContent='Nahlásit';
      btnReport.className='report';
      btnReport.onclick = ()=> {
        const r = { messageId: id, reporterId: auth.currentUser ? auth.currentUser.uid : 'anon', time: Date.now() };
        reportsRef.push(r).then(()=> alert('Nahlášeno.'));
      };

      // If current user is admin, show admin tools (delete/ban)
      adminsRef.child(auth.currentUser ? auth.currentUser.uid : 'noauth').once('value', aSnap=>{
        const adminTools = document.createElement('div');
        adminTools.className = 'admin-tools';
        if(aSnap.exists()){
          const del = document.createElement('button'); del.textContent='Smazat'; del.onclick = ()=> {
            if(confirm('Smazat tuto zprávu?')) messagesRef.child(id).remove();
          };
          const ban = document.createElement('button'); ban.textContent='Ban'; ban.onclick = ()=> {
            if(confirm('Zabanovat uživatele?')) bansRef.child(msgObj.userId).set(true);
          };
          adminTools.appendChild(del); adminTools.appendChild(ban);
        }
        div.appendChild(meta); div.appendChild(text); div.appendChild(btnReport); div.appendChild(adminTools);
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    });
  }

  // Realtime: load existing and child_added
  messagesRef.limitToLast(200).on('child_added', snap=>{
    addMessageToDom(snap.key, snap.val());
  });

  // send message
  sendBtn.addEventListener('click', async ()=>{
    const user = auth.currentUser;
    if(!user){ alert('Musíš být přihlášen.'); return; }
    // check ban
    const isBanned = await bansRef.child(user.uid).once('value');
    if(isBanned.exists()){ alert('Byl jsi zabanován.'); return; }
    const unameSnap = await usersRef.child(user.uid).child('username').once('value');
    const username = unameSnap.val();
    const text = textInput.value.trim();
    if(!text) return;
    const msg = { userId: user.uid, username: username, text: text, time: Date.now(), reports: 0 };
    messagesRef.push(msg).then(()=> { textInput.value=''; });
  });

  // klientská periodická údržba: smaže staré zprávy (pokud je klient otevřen)
  setInterval(()=>{
    const cutoff = Date.now() - 12*60*60*1000;
    messagesRef.orderByChild('time').endAt(cutoff).once('value', snap=>{
      snap.forEach(ch=> ch.ref.remove());
    });
  }, 60*60*1000); // každou hodinu

  // automatické refresh při spuštění: vyčistí DOM a znovu načte posledních 200 zpráv
  messagesRef.limitToLast(200).once('value', snap=>{
    messagesEl.innerHTML='';
    snap.forEach(ch => addMessageToDom(ch.key, ch.val()));
  });

  </script>
</body>
</html>
