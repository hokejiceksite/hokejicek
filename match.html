<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hokejíček — Přenos</title>
  <link rel="icon" href="/favicon.png">
  <meta name="description" content="Živý textový přenos — Hokejíček" />
  <style>
    :root{
      --bg:#ffffff; --text:#07142a; --muted:#546776; --accent:#0B6BFF;
      --card:#fbfdff; --radius:12px; --maxw:980px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--maxw);margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#08B4FF);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{margin:0;font-size:20px}
    .meta{color:var(--muted);font-size:14px;margin-top:6px}
    .card{background:var(--card);padding:14px;border-radius:12px;border:1px solid #eef6ff;margin-top:14px}
    #events{max-height:60vh;overflow:auto;padding:8px}
    .event{padding:10px;border-bottom:1px solid #eef7ff}
    .time{color:var(--muted);font-size:12px;margin-bottom:6px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;text-decoration:none;border:0;cursor:pointer}
    .ghost{background:transparent;border:1px solid #e6f3ff;color:var(--accent);padding:8px 12px;border-radius:8px}
    .small{font-size:13px;color:var(--muted)}
    .err{background:#fff1f2;border-left:4px solid #ef4444;padding:10px;border-radius:6px;margin-top:8px;color:#7f1d1d}
    .hint{background:#fffbeb;border-left:4px solid #f59e0b;padding:10px;border-radius:6px;margin-top:8px;color:#6b4b04}
    @media(max-width:720px){header{flex-direction:column;align-items:flex-start}.controls{width:100%;justify-content:space-between}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logo">H</div>
        <div>
          <h1 id="title">Přenos</h1>
          <div id="meta" class="meta small"></div>
        </div>
      </div>
      <div class="controls">
        <a class="ghost" href="/">← Zpět</a>
        <a class="ghost" href="/admin.html">Admin</a>
        <button id="copyLink" class="btn" title="Zkopírovat odkaz">Zkopírovat odkaz</button>
      </div>
    </header>

    <div id="status" class="small" style="margin-top:12px">Kontrola připojení...</div>

    <div class="card">
      <div id="events" aria-live="polite">
        <!-- události se načtou sem -->
      </div>

      <div id="empty" class="small" style="display:none;padding:12px;text-align:center;color:var(--muted)">Zatím žádné události.</div>
    </div>

    <footer style="margin-top:18px" class="small">© <span id="year"></span> Hokejíček — hokejicek.site</footer>
  </div>

  <!-- Firebase compat (pro čisté HTML) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ======= VLOŽENÝ firebaseConfig (z Firebase Console) =======
    const firebaseConfig = {
      apiKey: "AIzaSyCpbltZZZ1xq91rL9i92ZBdTNJLSyiahSK",
      authDomain: "hokejicek-live.firebaseapp.com",
      databaseURL: "https://hokejicek-live-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hokejicek-live",
      storageBucket: "hokejicek-live.appspot.com",
      messagingSenderId: "382599668613",
      appId: "1:382599668613:web:737bc3dd697bc5a1f95aec",
      measurementId: "G-Z3FP66RW29"
    };
    // =========================================================

    // inicializace
    try {
      firebase.initializeApp(firebaseConfig);
    } catch(e){
      console.error('Firebase init error', e);
      document.getElementById('status').textContent = 'Chyba při inicializaci Firebase: ' + (e.message || e);
    }

    const db = firebase.database();
    const statusEl = document.getElementById('status');
    const eventsEl = document.getElementById('events');
    const emptyEl = document.getElementById('empty');
    const titleEl = document.getElementById('title');
    const metaEl = document.getElementById('meta');

    // pomocné: načíst ID z URL ?id=...
    const params = new URLSearchParams(location.search);
    const matchId = params.get('id');

    if(!matchId){
      statusEl.innerHTML = '<div class="err">Chybí id zápasu v URL. Otevřete stránku přes odkaz ze seznamu přenosů.</div>';
      throw new Error('no match id');
    }

    // test připojení k DB
    function testDb(){
      if(!db){
        statusEl.innerHTML = '<div class="err">Realtime Database není inicializovaná (zkontrolujte databaseURL v firebaseConfig).</div>';
        return;
      }
      db.ref('/').once('value').then(()=> {
        statusEl.textContent = 'Připojeno k databázi. Načítám přenos...';
      }).catch(err=>{
        console.error('DB err', err);
        statusEl.innerHTML = '<div class="err">Nelze přistoupit k Realtime Database: ' + (err.message || err.code) + 
          '</div><div class="hint">Zkontrolujte Authorized domains v Firebase Project settings a databaseURL v configu.</div>';
      });
    }
    testDb();

    // načíst info o zápasu
    db.ref('matches/' + matchId).once('value').then(snap=>{
      const d = snap.val();
      if(!d){
        titleEl.textContent = 'Neznámý přenos';
        metaEl.textContent = '';
        statusEl.innerHTML = '<div class="err">Zápas nenalezen (chybné id nebo zápas nebyl vytvořen).</div>';
        emptyEl.style.display = 'block';
        return;
      }
      titleEl.textContent = (d.home||'Domácí') + ' — ' + (d.away||'Hosté');
      metaEl.textContent = d.startTime ? 'Start: ' + d.startTime : ('Vytvořeno: ' + (d.createdAt ? new Date(d.createdAt).toLocaleString() : '—'));
      statusEl.textContent = 'Připojeno. Sleduji události...';
    }).catch(err=>{
      console.error(err);
      statusEl.innerHTML = '<div class="err">Chyba při načítání info o zápasu: ' + (err.message || err.code) + '</div>';
    });

    // poslouchat události (child_added)
    const eventsRef = db.ref('events/' + matchId);
    eventsRef.on('child_added', snap => {
      const ev = snap.val();
      appendEvent(ev);
    });

    // volitelně můžete sledovat child_removed/changed pokud chcete mazání/úpravy
    eventsRef.on('child_removed', snap => {
      // jednoduché řešení: reload list
      // pokud chcete sofistikovaně, lze identifikovat podle snap.key
      renderAllFromDb(); // zjednoduší konzistenci
    });

    eventsRef.on('child_changed', snap => {
      renderAllFromDb();
    });

    // append single event
    function appendEvent(ev){
      emptyEl.style.display = 'none';
      const el = document.createElement('div');
      el.className = 'event';
      const time = document.createElement('div');
      time.className = 'time';
      time.textContent = ev.createdAt ? new Date(ev.createdAt).toLocaleString() : '';
      const text = document.createElement('div');
      text.innerHTML = sanitize(ev.text || '');
      el.appendChild(time);
      el.appendChild(text);
      eventsEl.appendChild(el);
      // auto-scroll to bottom
      eventsEl.scrollTop = eventsEl.scrollHeight;
    }

    // bezpečné základní sanitizace (odstraňuje tagy)
    function sanitize(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\\n/g,'<br>');
    }

    // kompletní render (na vyžádání)
    async function renderAllFromDb(){
      try {
        eventsEl.innerHTML = '';
        const snap = await db.ref('events/' + matchId).once('value');
        if(!snap.exists()){ emptyEl.style.display='block'; return; }
        snap.forEach(ch => {
          appendEvent(ch.val());
        });
      } catch(e){
        console.error('renderAll error', e);
      }
    }

    // tlačítko: zkopírovat permalink
    document.getElementById('copyLink').addEventListener('click', () => {
      const url = location.href;
      navigator.clipboard.writeText(url).then(()=> {
        alert('Odkaz zkopírován do schránky.');
      }).catch(()=> {
        prompt('Zkopírujte odkaz ručně:', url);
      });
    });

    // pokud není nic po chvíli -> zobrazit prázdný stav
    setTimeout(()=> {
      if(!eventsEl.hasChildNodes()){
        emptyEl.style.display = 'block';
      }
    }, 800);

    // optional: tlačítko pro manuální refresh (není zobrazené, ale můžete přidat)
    // window.renderAllFromDb = renderAllFromDb;
  </script>
</body>
</html>
